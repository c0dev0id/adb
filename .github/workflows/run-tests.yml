name: Run Tests

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  openbsd:
    if: github.event_name != 'workflow_dispatch' || inputs.test_openbsd
    name: OpenBSD
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build adb on OpenBSD
      shell: sh
      run: |
        set -eux
        SUDO=doas
        ${SUDO} pkg_add -v pkgconf libusb libressl || ${SUDO} pkg_add -v pkgconf libusb openssl || true

        CXX=${CXX:-c++}
        cd adb
        make clean || true
    
        # Build with android-base headers located at ../base/include
        make -j2 EXTRA_INCLUDES="-I../base/include" CXX="$CXX"
    
        # Smoke test: run the binary to ensure it starts
        if [ -x ./adb ]; then
          echo "adb binary built successfully. Running smoke test:"
          ./adb --version || ./adb -V || ./adb --help || true
        else
          echo "adb was not built (no ./adb)."
          exit 1
        fi
